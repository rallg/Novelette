%%
%% This is file Novelette-HeaderStyles.sty,
%% part of Novelette document class.
%% Copyright 2022 Robert Allgeyer.
%%
%% It may be used, distributed, and/or modified under the
%% conditions of the MIT License. See:
%% https://opensource.org/licenses/MIT
%% 
%%
\ProvidesFile{Novelette-HeaderStyles.sty}%
[2022/06/22 v0.0.1 LuaLaTeX file (header layouts and styles)]
%% 



%% In this file, `fancyhdr' syntax defines the layout. The layout is not
%% activated until \AtEndPreamble.


% It might be useful to know whether something is being placed in header.
% To make this work, \fancyhead is re-defined:
\newtoggle{@inheader} % True within header.
\LetLtxMacro{\@myfancyhead}{\fancyhead}
\renewcommand\fancyhead[2][]{%
  \@myfancyhead[#1]{\toggletrue{@inheader}{\normalsize #2}}% Not global.
}



\gdef\@HeaderStyle{1} % Default. Has header. Note: Never has footer.
\gdef\@VersoEmblem{} % No default emblem.
\gdef\@RectoEmblem{} % No default emblem.


%% SET HEADER STYLE AND RESERVE SPACE FOR HEADER
%% ----------------------------------------------------------------------------
% There are several pre-configured header styles, addressing every
%   situation likely to be seen in popular fiction. The style details are
%   coded, using `fancyhdr' syntax, in Novelette-HeaderStyles.sty.
% If you wish to create a custom header style, you must first choose
%   one of the pre-configured styles, then customize it. That way,
%   the layout engine knows whether header is present.
%
\gdef\SetHeaderStyle#1{%
  \if@coverart
    \gdef\@HeaderStyle{0} % Required: no header for coverart.
    \ifthenelse{\equal{#1}{0}}{}{
      \ClassWarning{Novelette}{^^JIn `coverart' no header allowed. Ignored.^^J}
    }
  \else
    \@tempTFfalse
    \ifthenelse{\equal{#1}{0}}{%
      \global\@HasHeaderfalse\@tempTFtrue%
    }{}
    \ifthenelse{\equal{#1}{1}}{%
      \global\@HasHeadertrue\@tempTFtrue%
    }{}
    % Ensure that user choice was on the allowed list:
    \if@tempTF\else
      \ClassError{Novelette}{Invalid choice for \string\SetHeaderStyle}%
        {\string\SetHeaderStyle\space needs choice of 0 or 1 ^^J%
        even if you wish to customize using fancyhdr syntax.}%
    \fi
    \gdef\@HeaderStyle{#1}
  \fi
}%
\SetHeaderStyle{1} % default, header only
%

% \SetLooseHead looseness factor (fontspec LetterSpace) 0=tight, 50=default
\gdef\SetLooseHead#1{
  \FPdiv{\@loosehead}{#1}{10} % change method fontspec w/ microtype
  \FPmin{\@looseheadN}{\@loosehead}{50} % don't want numbers too loose
  \FPdiv{\@looseheadword}{\@loosehead}{30} % Inter-word.
  \FPadd{\@looseheadword}{\@looseheadword}{1}
}
\SetLooseHead{50}


%
% See docs for what these emblems do, if used:
\newcommand\SetEmblems[2]{ % verso, recto
  \gdef\@VersoEmblem{{\headerfont #1}}
  \gdef\@RectoEmblem{{\headerfont #2}}
}
\let\SetEmblem\SetEmblems% for convenience
% If you want something fancier than \thepage:
\gdef\SetPageNumberStyle#1{% no small caps, so lowercase roman preserved
  \gdef\pagenumberstyle{{\addfontfeature{Letters=ResetAll}#1}}
}
\SetPageNumberStyle{\thepage}% no small caps
% See Novelette.cls for the accompanying AtBeginDocument routine.


%% INITIALIZE FANCYHDR
%% ----------------------------------------------------------------------------
% Earlier, space was reserved for header, but the header content was
% not specified. Now, package `fancyhdr' will be used to create the content.
% First, blank everything that might be pre-set in package `fancyhdr':
\renewcommand\headrulewidth{0pt}
\renewcommand\footrulewidth{0pt}
\fancyhead[LO,RE,LE,RO,CE,CO]{}
\fancyfoot[LO,RE,LE,RO,CE,CO]{}


%% THISPAGESTYLE COMMANDS
%% ----------------------------------------------------------------------------
% Re-define \thispagestyle based on layout.
\newif \if@ThisPageStyle % true if \thispagestyle declared for current page
\AtBeginShipout{% re-sets when page done
  \global\@ThisPageStylefalse%
}
\LetLtxMacro{\@myTempTPS}{\thispagestyle}
%
\gdef\thispagestyle#1{%
  \global\@ThisPageStyletrue%
  \@tempTFfalse%
  % Style `fancy' is same as normal style:
  \ifthenelse{\equal{#1}{fancy}}{%
    \@tempTFtrue%
    \@myTempTPS{fancy}%
  }{}%
  % Style `empty' has no visible content in header.
  % This style is pre-defined, so no need to re-define it here.
  \ifthenelse{\equal{#1}{empty}}{%
    \@tempTFtrue%
    \@myTempTPS{empty}%
  }{}%
  % Verify that an allowable choice was made:
  \if@tempTF\else%
    \ClassError{Novelette}{^^JPage \thepage\space has \string\thispagestyle ^^J%
     but its argument is not on the list of choices. See docs. ^^J}%
  \fi%
} % end \thispagestyle.

%%
\gdef\@lshftext{\headerfont\addfontfeature{LetterSpace=\@loosehead}}
\gdef\@lspagenum{\headerfont\addfontfeature{LetterSpace=\@looseheadN}}
%%

% Content of header text (if present) can be changed at any time within
%   the body, using the following commands. If not used, then
%   Verso is initialized to \theauthor and Recto is initialized to \thetitle
%   AtBeginDocument, with adjustments to interword spacing.
% If you wish, you may write the commands with empty arguments, in which case
%   the header still appears with page number (if present), but no text.
%
\gdef\NewVersoHeadText#1{\gdef\versoheadtext{#1}}
\let\SetVersoHeadText\NewVersoHeadText\relax % for convenience
\let\RenewVersoHeadText\NewVersoHeadText\relax % for convenience
%
\gdef\NewRectoHeadText#1{\gdef\rectoheadtext{#1}}
\LetLtxMacro\SetRectoHeadText\NewRectoHeadText\relax % for convenience
\LetLtxMacro\RenewRectoHeadText\NewRectoHeadText\relax % for convenience
%
%%


%% See AtBeginDocument routine in Novelette.cls:
%% ----------------------------------------------------------------------------
\gdef\@ActivateHeaderStyles{ % called AtBeginDocument by Novelette.cls
  % Pre-configured header styles, unless user over-rode them:
  % \versoheadtext is initialized to \theauthor
  % \rectoheadtext is initialized to \thetitle
  \@ifundefined{versoheadtext}{
    \NewVersoHeadText{\theauthor}
  }{}
  \@ifundefined{rectoheadtext}{
    \NewRectoHeadText{\thetitle}
  }{}
  %
  % ---------------------------------------------------------------------------
  \ifthenelse{\equal{\@HeaderStyle}{1}}{ % default
    \fancyhead[LE]{%
      \makebox[2.5em][l]{\@lspagenum\pagenumberstyle}%
      \@VersoEmblem%
    }
    \fancyhead[RO]{%
      \@RectoEmblem%
      \makebox[2.5em][r]{\@lspagenum\pagenumberstyle}%
    }
    \fancyhead[CE]{\@lshftext\versoheadtext}
    \fancyhead[CO]{\@lshftext\rectoheadtext}
  }{}
  %
  \ifthenelse{\equal{\@HeaderStyle}{4}}{
    \fancyhead[LE]{%
      \makebox[2.5em][l]{\@lspagenum\pagenumberstyle}%
      \@VersoEmblem%
      \hspace{1em}%
      {\@lshftext\versoheadtext}%
    }
    \fancyhead[RO]{%
      {\@lshftext\rectoheadtext}%
      \hspace{1em}%
      \@RectoEmblem%
      \makebox[2.5em][r]{\@lspagenum\pagenumberstyle}%
    }
  }{}
  %
  \ifthenelse{\equal{\@HeaderStyle}{6}}{
    \fancyhead[LE]{%
      \makebox[2.5em][l]{\@lspagenum\pagenumberstyle}%
      \@VersoEmblem%
    }
    \fancyhead[RO]{%
      \@RectoEmblem%
      \makebox[2.5em][r]{\@lspagenum\pagenumberstyle}%
    }
    \fancyhead[RE]{\@lshftext\versoheadtext}
    \fancyhead[LO]{\@lshftext\rectoheadtext}
  }{}

  % END PRE-DEFINED LAYOUTS AND STYLES.
  % ---------------------------------------------------------------------------
  %
  % Now put `fancyhdr' to work:
  \pagestyle{fancy} % default unless over-ridden by \thispagestyle{}
  %
} % end \@ActivateHeaderStyles
%
%%


%% Neutralize settings that cannot be used after Preamble:
\gdef\@DisableHeaderSettings{% called by `Novelette.cls' \AtBeginDocument
  \LetLtxMacro\SetHeaderStyle\relax
  \LetLtxMacro\SetLooseHead\relax
}% end \@DisableHeaderSettings
%%

% The following settings can continue to be re-issued after \begin{document}:
% \SetEmblems  also \SetEmblem
% \SetPageNumberStyle
% \SetVersoHeadText  also \New and \Renew
% \SetRectoHeadText  also \New and \Renew


%%
\endinput
%%
%% End of file Novelette-HeaderStyles.sty.


